services:
  # Neo4j Enterprise for testing
  neo4j-enterprise:
    image: neo4j:5.26-enterprise
    container_name: neo4j-dev
    ports:
      - "7474:7474"   # HTTP
      - "7687:7687"   # Bolt
      - "7473:7473"   # HTTPS
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_EDITION: enterprise
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 1G
      NEO4J_server_memory_pagecache_size: 512m
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*,algo.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*,algo.*"
      NEO4J_server_bolt_listen__address: 0.0.0.0:7687
      NEO4J_server_http_listen__address: 0.0.0.0:7474
      NEO4J_server_https_listen__address: 0.0.0.0:7473
      NEO4J_server_logs_user_level: DEBUG
      NEO4J_server_logs_gc_enabled: "true"
      NEO4J_server_logs_gc_options: "-XX:+UseG1GC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution"
      # Cluster settings for testing
      NEO4J_causal__clustering_minimum__core__cluster__size__at__formation: 3
      NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime: 3
      NEO4J_causal__clustering_initial__discovery__members: "neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000"
      NEO4J_causal__clustering_discovery__listen__address: 0.0.0.0:5000
      NEO4J_causal__clustering_transaction__listen__address: 0.0.0.0:6000
      NEO4J_causal__clustering_raft__listen__address: 0.0.0.0:7000
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
      - ./dev-data/neo4j-config:/conf
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p password 'RETURN 1'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - neo4j-net

  # Neo4j Cluster Core Nodes for testing
  neo4j-core-1:
    image: neo4j:5.26-enterprise
    container_name: neo4j-core-1
    ports:
      - "7475:7474"
      - "7688:7687"
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_EDITION: enterprise
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
      NEO4J_server_memory_pagecache_size: 256m
      NEO4J_causal__clustering_minimum__core__cluster__size__at__formation: 3
      NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime: 3
      NEO4J_causal__clustering_initial__discovery__members: "neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000"
      NEO4J_causal__clustering_discovery__listen__address: 0.0.0.0:5000
      NEO4J_causal__clustering_transaction__listen__address: 0.0.0.0:6000
      NEO4J_causal__clustering_raft__listen__address: 0.0.0.0:7000
      NEO4J_server_logs_user_level: INFO
    volumes:
      - neo4j-core-1-data:/data
      - neo4j-core-1-logs:/logs
    networks:
      - neo4j-net
    profiles:
      - cluster

  neo4j-core-2:
    image: neo4j:5.26-enterprise
    container_name: neo4j-core-2
    ports:
      - "7476:7474"
      - "7689:7687"
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_EDITION: enterprise
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
      NEO4J_server_memory_pagecache_size: 256m
      NEO4J_causal__clustering_minimum__core__cluster__size__at__formation: 3
      NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime: 3
      NEO4J_causal__clustering_initial__discovery__members: "neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000"
      NEO4J_causal__clustering_discovery__listen__address: 0.0.0.0:5000
      NEO4J_causal__clustering_transaction__listen__address: 0.0.0.0:6000
      NEO4J_causal__clustering_raft__listen__address: 0.0.0.0:7000
      NEO4J_server_logs_user_level: INFO
    volumes:
      - neo4j-core-2-data:/data
      - neo4j-core-2-logs:/logs
    networks:
      - neo4j-net
    profiles:
      - cluster

  neo4j-core-3:
    image: neo4j:5.26-enterprise
    container_name: neo4j-core-3
    ports:
      - "7477:7474"
      - "7690:7687"
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
      NEO4J_EDITION: enterprise
      NEO4J_server_memory_heap_initial__size: 256m
      NEO4J_server_memory_heap_max__size: 512m
      NEO4J_server_memory_pagecache_size: 256m
      NEO4J_causal__clustering_minimum__core__cluster__size__at__formation: 3
      NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime: 3
      NEO4J_causal__clustering_initial__discovery__members: "neo4j-core-1:5000,neo4j-core-2:5000,neo4j-core-3:5000"
      NEO4J_causal__clustering_discovery__listen__address: 0.0.0.0:5000
      NEO4J_causal__clustering_transaction__listen__address: 0.0.0.0:6000
      NEO4J_causal__clustering_raft__listen__address: 0.0.0.0:7000
      NEO4J_server_logs_user_level: INFO
    volumes:
      - neo4j-core-3-data:/data
      - neo4j-core-3-logs:/logs
    networks:
      - neo4j-net
    profiles:
      - cluster

  # Prometheus for monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./dev-data/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - neo4j-net
    profiles:
      - monitoring

  # Grafana for dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: grafana-dev
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./dev-data/grafana/provisioning:/etc/grafana/provisioning
      - ./dev-data/grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - neo4j-net
    profiles:
      - monitoring

  # Redis for caching (development use)
  redis:
    image: redis:7-alpine
    container_name: redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --save 20 1 --loglevel warning
    networks:
      - neo4j-net
    profiles:
      - cache

  # MinIO for S3-compatible storage testing
  minio:
    image: minio/minio:latest
    container_name: minio-dev
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - neo4j-net
    profiles:
      - storage

  # LocalStack for AWS services simulation
  localstack:
    image: localstack/localstack:latest
    container_name: localstack-dev
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      SERVICES: s3,iam,sts,secretsmanager,kms
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - localstack-data:/tmp/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - neo4j-net
    profiles:
      - aws

  # Jaeger for distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger-dev
    ports:
      - "16686:16686"
      - "14268:14268"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    networks:
      - neo4j-net
    profiles:
      - tracing

  # Development tooling container
  dev-tools:
    build:
      context: .
      dockerfile: Dockerfile.dev-tools
    container_name: neo4j-operator-dev-tools
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    environment:
      KUBECONFIG: /workspace/.kube/config
    networks:
      - neo4j-net
    profiles:
      - tools

volumes:
  neo4j-data:
  neo4j-logs:
  neo4j-import:
  neo4j-plugins:
  neo4j-core-1-data:
  neo4j-core-1-logs:
  neo4j-core-2-data:
  neo4j-core-2-logs:
  neo4j-core-3-data:
  neo4j-core-3-logs:
  prometheus-data:
  grafana-data:
  redis-data:
  minio-data:
  localstack-data:

networks:
  neo4j-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
