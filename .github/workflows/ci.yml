name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run-integration-tests:
        description: 'Run integration tests'
        required: false
        default: true
        type: boolean

env:
  GO_VERSION: '1.24'
  KIND_VERSION: 'v0.20.0'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run unit tests
      run: |
        # Enable line-buffered output for real-time progress
        export PYTHONUNBUFFERED=1
        export FORCE_COLOR=1

        echo "Running unit tests with enhanced progress output..."
        # Use pipefail to ensure the exit code from make test-unit is propagated
        set -o pipefail
        make test-unit | tee unit-test-output.log
      env:
        GOMAXPROCS: 2

    - name: Generate test summary
      if: always()
      run: |
        echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f unit-test-output.log ]; then
          # Count passed/failed tests from the output
          PASSED=$(grep -c "PASS:" unit-test-output.log || echo "0")
          FAILED=$(grep -c "FAIL:" unit-test-output.log || echo "0")

          if [ "$FAILED" = "0" ]; then
            echo "âœ… **Status**: All unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: $FAILED test(s) failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“Š **Summary**: $PASSED passed, $FAILED failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status**: Test output not available" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Artifacts**: Test logs and coverage reports available for download" >> $GITHUB_STEP_SUMMARY

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          coverage/
          *.out
          unit-test-output.log
        if-no-files-found: warn

  integration-tests-info:
    name: Integration Tests Info
    runs-on: ubuntu-latest
    if: |
      !(
        contains(github.event.pull_request.labels.*.name, 'run-integration-tests') ||
        contains(github.event.head_commit.message, '[run-integration]') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run-integration-tests == 'true')
      )

    steps:
    - name: Integration tests skipped
      run: |
        echo "## â­ï¸ Integration Tests Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Integration tests are optional and can be triggered by:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ·ï¸ PR Label Method:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "gh pr edit --add-label \"run-integration-tests\"" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ’¬ Commit Message Method:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo 'git commit -m "feat: cluster changes [run-integration]"' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ–±ï¸ Manual Dispatch Method:" >> $GITHUB_STEP_SUMMARY
        echo "Actions â†’ CI â†’ Run workflow â†’ Check \"Run integration tests\"" >> $GITHUB_STEP_SUMMARY

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: |
      contains(github.event.pull_request.labels.*.name, 'run-integration-tests') ||
      contains(github.event.head_commit.message, '[run-integration]') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run-integration-tests == 'true')
    timeout-minutes: 90
    permissions: write-all

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Kubernetes environment
      uses: ./.github/actions/setup-k8s
      with:
        kind-version: ${{ env.KIND_VERSION }}

    - name: Run integration tests
      run: |
        # Enable line-buffered output for real-time progress
        export PYTHONUNBUFFERED=1
        export FORCE_COLOR=1

        echo "Running integration tests with enhanced logging..."
        # Use pipefail to ensure the exit code from make test-integration is propagated
        set -o pipefail
        make test-integration | tee integration-test-output.log
      env:
        KUBECONFIG: /home/runner/.kube/config
        FORCE_COLOR: 1
        GOMAXPROCS: 1
        MCP_REGISTRY_USERNAME: ${{ github.actor }}
        MCP_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

    - name: Collect cluster state
      if: always()
      run: |
        echo "=== Cluster Nodes ==="
        kubectl get nodes -o wide || true

        echo "=== All Pods ==="
        kubectl get pods --all-namespaces || true

        echo "=== Neo4j Resources ==="
        kubectl get neo4jenterpriseclusters,neo4jenterprisestandalones,neo4jdatabases,neo4jplugins --all-namespaces || true

        echo "=== Recent Events ==="
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -50 || true

    - name: Collect cluster logs
      uses: ./.github/actions/collect-logs
      if: always()
      with:
        artifact-name: integration-test-logs

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          coverage/
          *.out
          integration-test-output.log
        if-no-files-found: warn

    - name: Cleanup test cluster
      if: always()
      run: make test-cluster-delete || true
