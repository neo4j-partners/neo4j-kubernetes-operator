name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GO_VERSION: '1.22'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run unit tests
      run: |
        # Enable line-buffered output for real-time progress
        export PYTHONUNBUFFERED=1
        export FORCE_COLOR=1

        echo "Running unit tests with enhanced progress output..."
        make test-unit | tee unit-test-output.log

        # Also save the exit code
        echo "Unit tests completed with exit code: $?"
      env:
        GOMAXPROCS: 2

    - name: Generate test summary
      if: always()
      run: |
        echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f unit-test-output.log ]; then
          # Count passed/failed tests from the output
          PASSED=$(grep -c "PASS:" unit-test-output.log || echo "0")
          FAILED=$(grep -c "FAIL:" unit-test-output.log || echo "0")

          if [ "$FAILED" = "0" ]; then
            echo "âœ… **Status**: All unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: $FAILED test(s) failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ“Š **Summary**: $PASSED passed, $FAILED failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Status**: Test output not available" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Artifacts**: Test logs and coverage reports available for download" >> $GITHUB_STEP_SUMMARY

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          coverage/
          *.out
          unit-test-output.log
        if-no-files-found: warn
