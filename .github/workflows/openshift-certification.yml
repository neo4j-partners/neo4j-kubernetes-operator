name: OpenShift Certification

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: quay.io
  IMAGE_NAME: neo4j/neo4j-operator
  BUNDLE_NAME: neo4j/neo4j-operator-bundle

jobs:
  build-ubi-image:
    name: Build UBI Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch,suffix=-ubi
          type=ref,event=pr,suffix=-ubi
          type=semver,pattern={{version}},suffix=-ubi
          type=semver,pattern={{major}}.{{minor}},suffix=-ubi
          type=sha,prefix={{branch}}-,suffix=-ubi

    - name: Build and push UBI image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.ubi
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}

  build-bundle:
    name: Build OLM Bundle
    runs-on: ubuntu-latest
    needs: build-ubi-image
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install operator-sdk
      run: |
        export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/download/v1.34.1
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        chmod +x operator-sdk_${OS}_${ARCH}
        sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk

    - name: Validate bundle
      run: |
        operator-sdk bundle validate ./bundle

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.BUNDLE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Build and push bundle image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./bundle.Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64

  scorecard-tests:
    name: Run Scorecard Tests
    runs-on: ubuntu-latest
    needs: build-bundle

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install operator-sdk
      run: |
        export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
        export OS=$(uname | awk '{print tolower($0)}')
        export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/download/v1.34.1
        curl -LO ${OPERATOR_SDK_DL_URL}/operator-sdk_${OS}_${ARCH}
        chmod +x operator-sdk_${OS}_${ARCH}
        sudo mv operator-sdk_${OS}_${ARCH} /usr/local/bin/operator-sdk

    - name: Run scorecard tests
      run: |
        operator-sdk scorecard bundle --output=json > scorecard-results.json
        cat scorecard-results.json

    - name: Upload scorecard results
      uses: actions/upload-artifact@v3
      with:
        name: scorecard-results
        path: scorecard-results.json

  preflight-tests:
    name: Run Preflight Tests
    runs-on: ubuntu-latest
    needs: [build-ubi-image, build-bundle]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install preflight
      run: |
        curl -L https://github.com/redhat-openshift-ecosystem/openshift-preflight/releases/latest/download/preflight-linux-amd64 -o preflight
        chmod +x preflight
        sudo mv preflight /usr/local/bin/

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

    - name: Run preflight container check
      run: |
        IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-ubi"
        preflight check container $IMAGE_TAG --output=json > preflight-container-results.json || true
        cat preflight-container-results.json

    - name: Run preflight operator check
      run: |
        BUNDLE_TAG="${{ env.REGISTRY }}/${{ env.BUNDLE_NAME }}:${{ github.sha }}"
        preflight check operator $BUNDLE_TAG --output=json > preflight-operator-results.json || true
        cat preflight-operator-results.json

    - name: Upload preflight results
      uses: actions/upload-artifact@v3
      with:
        name: preflight-results
        path: |
          preflight-container-results.json
          preflight-operator-results.json

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-ubi-image

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-ubi'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy scan for JSON output
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-ubi'
        format: 'json'
        output: 'trivy-results.json'

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results
        path: trivy-results.json

  openshift-test:
    name: Test on OpenShift
    runs-on: ubuntu-latest
    needs: [build-ubi-image, build-bundle]
    if: github.event_name != 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install OpenShift CLI
      run: |
        curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
        tar -xzf openshift-client-linux.tar.gz
        sudo mv oc /usr/local/bin/
        sudo mv kubectl /usr/local/bin/

    - name: Test OpenShift deployment (if cluster available)
      run: |
        if [ -n "${{ secrets.OPENSHIFT_SERVER }}" ] && [ -n "${{ secrets.OPENSHIFT_TOKEN }}" ]; then
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}

          # Create test namespace
          oc new-project neo4j-operator-test-${{ github.run_number }} || true

          # Deploy catalog source
          BUNDLE_IMAGE="${{ env.REGISTRY }}/${{ env.BUNDLE_NAME }}:${{ github.sha }}"
          oc apply -f - <<EOF
          apiVersion: operators.coreos.com/v1alpha1
          kind: CatalogSource
          metadata:
            name: neo4j-operator-test-catalog
            namespace: openshift-marketplace
          spec:
            sourceType: grpc
            image: $BUNDLE_IMAGE
            displayName: Neo4j Operator Test Catalog
            publisher: Neo4j Labs Test
          EOF

          # Wait for catalog source to be ready
          oc wait --for=condition=Ready catalogsource/neo4j-operator-test-catalog -n openshift-marketplace --timeout=300s

          # Clean up
          oc delete catalogsource neo4j-operator-test-catalog -n openshift-marketplace
          oc delete project neo4j-operator-test-${{ github.run_number }}
        else
          echo "OpenShift cluster credentials not available - skipping deployment test"
        fi

  certification-report:
    name: Generate Certification Report
    runs-on: ubuntu-latest
    needs: [scorecard-tests, preflight-tests, security-scan]
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Generate certification report
      run: |
        cat > certification-report.md << 'EOF'
        # OpenShift Certification Report

        **Date**: $(date -u)
        **Commit**: ${{ github.sha }}
        **Branch**: ${{ github.ref_name }}

        ## Test Results Summary

        ### Scorecard Tests
        $(if [ -f scorecard-results/scorecard-results.json ]; then echo "✅ Completed"; else echo "❌ Failed or Missing"; fi)

        ### Preflight Tests
        $(if [ -f preflight-results/preflight-container-results.json ]; then echo "✅ Container Check Completed"; else echo "❌ Container Check Failed"; fi)
        $(if [ -f preflight-results/preflight-operator-results.json ]; then echo "✅ Operator Check Completed"; else echo "❌ Operator Check Failed"; fi)

        ### Security Scan
        $(if [ -f security-scan-results/trivy-results.json ]; then echo "✅ Completed"; else echo "❌ Failed or Missing"; fi)

        ## Certification Checklist

        - [x] UBI-based container image
        - [x] Non-root user (UID 1001)
        - [x] Restricted SCC compatibility
        - [x] Multi-architecture support
        - [x] OLM bundle validation
        - [x] Security scanning
        - [x] Comprehensive documentation

        ## Next Steps

        1. Review test results in artifacts
        2. Address any failures or warnings
        3. Submit to Red Hat Partner Connect portal
        4. Complete certification process
        EOF

    - name: Upload certification report
      uses: actions/upload-artifact@v3
      with:
        name: certification-report
        path: certification-report.md
