name: Extended Integration Tests

on:
  workflow_dispatch:
    inputs:
      neo4j-version:
        description: 'Neo4j version to test against'
        required: false
        default: '5.26-enterprise'
        type: string
      timeout-minutes:
        description: 'Test timeout in minutes'
        required: false
        default: '90'
        type: string

env:
  GO_VERSION: '1.22'
  KIND_VERSION: 'v0.20.0'

jobs:
  extended-integration-tests:
    name: Extended Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(github.event.inputs.timeout-minutes || '90') }}
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Kubernetes environment
      uses: ./.github/actions/setup-k8s
      with:
        kind-version: ${{ env.KIND_VERSION }}

    - name: Setup test cluster and deploy operator
      run: |
        echo "Creating test cluster and deploying operator..."
        make test-cluster

    - name: Pre-load Neo4j images to avoid Docker rate limits
      run: |
        echo "Pre-loading Neo4j image to avoid Docker rate limits..."

        # Define the Neo4j version to use for all tests
        NEO4J_VERSION="${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}"
        echo "Neo4j version for tests: ${NEO4J_VERSION}"

        # Pull the specific Neo4j image
        echo "Pulling Neo4j image: neo4j:${NEO4J_VERSION}"
        if ! docker pull neo4j:${NEO4J_VERSION}; then
          echo "‚ùå ERROR: Failed to pull neo4j:${NEO4J_VERSION}"
          echo "This image is required for integration tests to run."
          exit 1
        fi
        echo "‚úÖ Successfully pulled neo4j:${NEO4J_VERSION}"

        # Load the image into Kind cluster
        echo "Loading neo4j:${NEO4J_VERSION} into Kind cluster..."
        if ! kind load docker-image neo4j:${NEO4J_VERSION} --name neo4j-operator-test; then
          echo "‚ùå ERROR: Failed to load image into Kind cluster"
          exit 1
        fi
        echo "‚úÖ Successfully loaded neo4j:${NEO4J_VERSION} into Kind"

        # Verify the image is available in the cluster
        echo "Verifying image availability in Kind cluster:"
        if docker exec neo4j-operator-test-control-plane crictl images | grep -q "neo4j.*${NEO4J_VERSION}"; then
          echo "‚úÖ Image neo4j:${NEO4J_VERSION} is available in Kind cluster"
        else
          echo "‚ö†Ô∏è Warning: Could not verify image in Kind cluster"
          docker exec neo4j-operator-test-control-plane crictl images | grep neo4j || echo "No Neo4j images found"
        fi

    - name: Run extended integration tests
      run: |
        # Enable line-buffered output for real-time progress
        export PYTHONUNBUFFERED=1
        export FORCE_COLOR=1

        echo "Running extended integration tests with custom Neo4j version..."
        echo "üìä Neo4j version: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}"
        echo "üîó Running full integration test suite..."

        # Install ginkgo CLI for running tests
        go install github.com/onsi/ginkgo/v2/ginkgo@latest

        # Deploy operator with correct image and run tests
        make docker-build IMG=neo4j-operator:integration-test
        kind load docker-image neo4j-operator:integration-test --name neo4j-operator-test

        # Deploy to neo4j-operator-system namespace (where tests expect it)
        # Ensure kustomize is available
        make kustomize

        # Create a temporary kustomization overlay directory for CI with local image
        mkdir -p config/overlays/ci-temp
        cat <<EOF > config/overlays/ci-temp/kustomization.yaml
        apiVersion: kustomize.config.k8s.io/v1beta1
        kind: Kustomization
        namespace: neo4j-operator-system
        resources:
        - ../../default
        images:
        - name: controller
          newName: neo4j-operator
          newTag: integration-test
        EOF

        # Verify the overlay produces the correct image
        echo "Verifying kustomize overlay produces correct image..."
        ./bin/kustomize build config/overlays/ci-temp | grep "image:" | grep -v "description:" || true

        # Deploy using the temporary overlay
        ./bin/kustomize build config/overlays/ci-temp | kubectl apply -f -

        # Wait for deployment and verify the image
        kubectl wait --for=condition=available --timeout=120s deployment/neo4j-operator-controller-manager -n neo4j-operator-system || true
        kubectl describe deployment neo4j-operator-controller-manager -n neo4j-operator-system | grep -A 2 "Image:" || true

        # Run all integration tests
        # Use pipefail to ensure test failures are properly propagated through the pipe
        set -o pipefail
        ginkgo run -v --timeout=60m ./test/integration/... | tee integration-test-output.log
      env:
        KUBECONFIG: /home/runner/.kube/config
        NEO4J_VERSION: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}
        FORCE_COLOR: 1
        GOMAXPROCS: 1
        MCP_REGISTRY_USERNAME: ${{ github.actor }}
        MCP_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

    - name: Collect cluster state
      if: always()
      run: |
        echo "=== Cluster Nodes ==="
        kubectl get nodes -o wide || true

        echo "=== All Pods ==="
        kubectl get pods --all-namespaces || true

        echo "=== Neo4j Resources ==="
        kubectl get neo4jenterpriseclusters,neo4jenterprisestandalones,neo4jdatabases,neo4jplugins --all-namespaces || true

        echo "=== Recent Events ==="
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -50 || true

    - name: Collect cluster logs
      uses: ./.github/actions/collect-logs
      if: always()
      with:
        artifact-name: integration-test-logs

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          coverage/
          *.out
          integration-test-output.log
        if-no-files-found: warn

    - name: Archive cluster state dump
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cluster-state-dump
        path: |
          /tmp/cluster-logs/
        if-no-files-found: warn

    - name: Cleanup test cluster
      if: always()
      run: make test-cluster-delete || true

  extended-integration-test-summary:
    name: Extended Integration Test Summary
    runs-on: ubuntu-latest
    needs: [extended-integration-tests]
    if: always()

    steps:
    - name: Extended Integration Test Summary
      run: |
        echo "## Extended Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.extended-integration-tests.result }}" == "success" ]; then
          echo "‚úÖ **Extended Integration Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All extended integration tests completed successfully with custom Neo4j version." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.extended-integration-tests.result }}" == "failure" ]; then
          echo "‚ùå **Extended Integration Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extended integration tests encountered failures. Check the logs and artifacts for details." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.extended-integration-tests.result }}" == "cancelled" ]; then
          echo "‚èπÔ∏è **Extended Integration Tests**: CANCELLED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extended integration tests were cancelled before completion." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Extended Integration Tests**: UNKNOWN STATUS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Neo4j Version**: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout**: ${{ github.event.inputs.timeout-minutes || '90' }} minutes" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Suite**: Full integration suite with custom Neo4j version" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Extended integration test logs and cluster state dumps are available as workflow artifacts" >> $GITHUB_STEP_SUMMARY
