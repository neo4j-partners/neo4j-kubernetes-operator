name: Extended Integration Tests

on:
  workflow_dispatch:
    inputs:
      neo4j-version:
        description: 'Neo4j version to test against'
        required: false
        default: '5.26-enterprise'
        type: string
      timeout-minutes:
        description: 'Test timeout in minutes'
        required: false
        default: '90'
        type: string

env:
  GO_VERSION: '1.24'
  KIND_VERSION: 'v0.20.0'

jobs:
  extended-integration-tests:
    name: Extended Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(github.event.inputs.timeout-minutes || '90') }}
    permissions: write-all

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go environment
      uses: ./.github/actions/setup-go
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Kubernetes environment
      uses: ./.github/actions/setup-k8s
      with:
        kind-version: ${{ env.KIND_VERSION }}

    - name: Create cluster and deploy operator
      run: |
        NEO4J_VERSION="${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}"

        echo "â–¶ Creating test cluster..."
        make test-cluster

        echo "â–¶ Installing CRDs..."
        make manifests install

        echo "â–¶ Building operator image..."
        make docker-build IMG=neo4j-operator:integration-test
        kind load docker-image neo4j-operator:integration-test --name neo4j-operator-test

        echo "â–¶ Building MCP image..."
        make mcp-docker-build MCP_IMAGE=neo4j-operator-mcp:integration-test
        kind load docker-image neo4j-operator-mcp:integration-test --name neo4j-operator-test

        echo "â–¶ Deploying operator to neo4j-operator-system..."
        make kustomize
        mkdir -p config/overlays/ci-temp
        cat > config/overlays/ci-temp/kustomization.yaml <<EOF
        apiVersion: kustomize.config.k8s.io/v1beta1
        kind: Kustomization
        namespace: neo4j-operator-system
        resources:
        - ../../default
        images:
        - name: ghcr.io/neo4j-partners/neo4j-kubernetes-operator
          newName: neo4j-operator
          newTag: integration-test
        EOF
        ./bin/kustomize build config/overlays/ci-temp | kubectl apply -f -

        echo "â–¶ Waiting for operator to be ready..."
        kubectl wait --for=condition=available --timeout=120s \
          deployment/neo4j-operator-controller-manager -n neo4j-operator-system
        kubectl describe deployment neo4j-operator-controller-manager \
          -n neo4j-operator-system | grep -A2 "Image:" || true

        echo "â–¶ Pre-loading Neo4j image: neo4j:${NEO4J_VERSION}"
        # Both `kind load docker-image` and `kind load image-archive` pipe
        # docker save output to `ctr images import --all-platforms`, which
        # chases every digest in the OCI manifest index and fails on blobs for
        # other platforms not downloaded locally.
        #
        # Docker 27+ uses the containerd image store by default, which stores
        # the full OCI manifest index even for a `--platform linux/amd64` pull,
        # so the `docker save` archive always contains the multi-platform index.
        #
        # Fix: bypass Kind's loader entirely and run `ctr import` directly
        # WITHOUT `--all-platforms`. Containerd then imports only the manifest
        # that matches the Kind node's platform (linux/amd64) and ignores the
        # others whose blobs are absent.
        if ! docker pull --platform linux/amd64 neo4j:${NEO4J_VERSION}; then
          echo "âŒ Failed to pull neo4j:${NEO4J_VERSION} â€” image is required for tests"
          exit 1
        fi
        docker save neo4j:${NEO4J_VERSION} | \
          docker exec --privileged -i neo4j-operator-test-control-plane \
          ctr --namespace=k8s.io images import --snapshotter=overlayfs -
        echo "âœ… neo4j:${NEO4J_VERSION} loaded into Kind"

    - name: Run extended integration tests
      run: |
        export FORCE_COLOR=1
        echo "ðŸ“Š Neo4j version: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}"
        echo "ðŸ”— Running full integration test suite..."

        # Use the project-pinned ginkgo binary (make ginkgo downloads to ./bin/ginkgo)
        make ginkgo

        set -o pipefail
        MCP_TEST_IMAGE=neo4j-operator-mcp:integration-test \
          ./bin/ginkgo run -v --timeout=60m ./test/integration/... | tee integration-test-output.log
      env:
        KUBECONFIG: /home/runner/.kube/config
        NEO4J_VERSION: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}
        FORCE_COLOR: 1
        MCP_REGISTRY_USERNAME: ${{ github.actor }}
        MCP_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

    - name: Collect cluster state
      if: always()
      run: |
        echo "=== Cluster Nodes ==="
        kubectl get nodes -o wide || true

        echo "=== All Pods ==="
        kubectl get pods --all-namespaces || true

        echo "=== Neo4j Resources ==="
        kubectl get neo4jenterpriseclusters,neo4jenterprisestandalones,neo4jdatabases,neo4jplugins --all-namespaces || true

        echo "=== Recent Events ==="
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -50 || true

    - name: Collect cluster logs
      uses: ./.github/actions/collect-logs
      if: always()
      with:
        artifact-name: integration-test-logs

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          coverage/
          *.out
          integration-test-output.log
        if-no-files-found: warn

    - name: Archive cluster state dump
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cluster-state-dump
        path: |
          /tmp/cluster-logs/
        if-no-files-found: warn

    - name: Cleanup test cluster
      if: always()
      run: make test-cluster-delete || true

  extended-integration-test-summary:
    name: Extended Integration Test Summary
    runs-on: ubuntu-latest
    needs: [extended-integration-tests]
    if: always()

    steps:
    - name: Extended Integration Test Summary
      run: |
        echo "## Extended Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.extended-integration-tests.result }}" == "success" ]; then
          echo "âœ… **Extended Integration Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All extended integration tests completed successfully with custom Neo4j version." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.extended-integration-tests.result }}" == "failure" ]; then
          echo "âŒ **Extended Integration Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extended integration tests encountered failures. Check the logs and artifacts for details." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.extended-integration-tests.result }}" == "cancelled" ]; then
          echo "â¹ï¸ **Extended Integration Tests**: CANCELLED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extended integration tests were cancelled before completion." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Extended Integration Tests**: UNKNOWN STATUS" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Neo4j Version**: ${{ github.event.inputs.neo4j-version || '5.26-enterprise' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timeout**: ${{ github.event.inputs.timeout-minutes || '90' }} minutes" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Suite**: Full integration suite with custom Neo4j version" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- Extended integration test logs and cluster state dumps are available as workflow artifacts" >> $GITHUB_STEP_SUMMARY
