# Development tools container for Neo4j Operator
FROM golang:1.21-alpine AS go-tools

# Install Go development tools
RUN go install golang.org/x/tools/cmd/goimports@latest && \
    go install github.com/go-delve/delve/cmd/dlv@latest && \
    go install github.com/air-verse/air@latest && \
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest && \
    go install github.com/onsi/ginkgo/v2/ginkgo@latest && \
    go install honnef.co/go/tools/cmd/staticcheck@latest && \
    go install github.com/vektra/mockery/v2@latest && \
    go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest && \
    go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest && \
    go install golang.org/x/vuln/cmd/govulncheck@latest

FROM alpine:3.19

# Install system dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    jq \
    make \
    docker-cli \
    docker-compose \
    openssh-client \
    ca-certificates \
    tzdata

# Install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/

# Install kind
RUN curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64 && \
    chmod +x ./kind && \
    mv ./kind /usr/local/bin/kind

# Install helm
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Install tilt
RUN curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash

# Install Go
COPY --from=golang:1.21-alpine /usr/local/go /usr/local/go
ENV PATH="/usr/local/go/bin:${PATH}"

# Copy Go tools
COPY --from=go-tools /go/bin/* /usr/local/bin/

# Create workspace
WORKDIR /workspace

# Copy development scripts
COPY scripts/ /workspace/scripts/
RUN chmod +x /workspace/scripts/*.sh

# Set default shell
SHELL ["/bin/bash", "-c"]

# Default command
CMD ["/bin/bash"]
